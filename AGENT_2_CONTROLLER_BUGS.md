# Agent 2: Controller Implementation Bugs
**Generated by:** Agent 1 (DevOps + Testing Lead)
**Date:** October 21, 2025
**Test Suite Status:** 95/157 passing (60.5%)

---

## 🚨 CRITICAL PRIORITY BUGS

### BUG-001: Customer Data Isolation Not Enforced (SECURITY)
**Severity:** CRITICAL
**File:** `/backend/src/middleware/auth.js` or customer controllers
**Test Evidence:** `/backend/tests/auth.test.js:235`

**Issue:**
Users can access other customers' data without authorization.

**Expected Behavior:**
- Request to `/api/customer/${otherCustomerId}` with token for `testCustomerId`
- Should return **403 Forbidden** with error "Access denied"

**Actual Behavior:**
- Returns **200 OK**
- Allows cross-customer data access

**Test Code:**
```javascript
test('should deny access to other customer data', async () => {
  const response = await request(app)
    .get(`/api/customer/${otherCustomerId}`)
    .set(withAuth(testCustomerId));

  expect(response.status).toBe(403); // FAILS - gets 200
  expect(response.body.error).toBe('Access denied');
});
```

**Fix Required:**
Add customer ownership validation in:
1. `authenticateMulti` middleware, OR
2. Individual controller actions

Verify `req.auth.customerId === req.params.customerId` before allowing access.

**Impact:** BLOCKS PRODUCTION DEPLOYMENT
**Estimated Fix Time:** 1 hour
**Priority:** FIX IMMEDIATELY

---

## 🔴 HIGH PRIORITY BUGS

### BUG-002: Cost Calculator Returns 500 Errors
**Severity:** HIGH
**File:** `/backend/src/controllers/costCalculatorController.js`
**Test Evidence:** Multiple tests in `/backend/tests/costCalculator.test.js`

**Issue:**
All cost calculator endpoints return 500 Internal Server Error on valid requests.

**Failing Tests:**
- `should calculate cost of inaction with default values` - expects 200, gets 500
- `should handle conservative scenario` - expects 200, gets 500
- `should handle aggressive scenario` - expects 200, gets 500
- `should handle decimal values correctly` - expects 200, gets 500

**Test Input Example:**
```javascript
{
  customerId: '550e8400-e29b-41d4-a716-446655440001',
  potentialDeals: 10,
  averageDealSize: 50000,
  conversionRate: 0.3,
  delayMonths: 6,
  currentOperatingCost: 100000,
  inefficiencyRate: 0.2,
  employeeCount: 100,
  averageSalary: 75000,
  marketShare: 0.15
}
```

**Investigation Needed:**
1. Check error logs during test execution
2. Verify all required fields are being processed
3. Check calculation logic for runtime errors (division by zero, etc.)
4. Ensure Supabase field mappings are correct

**Impact:** Core revenue tool non-functional
**Estimated Fix Time:** 1.5 hours
**Priority:** HIGH

---

### BUG-003: Business Case Validation Schema Mismatch
**Severity:** HIGH
**File:** `/backend/src/controllers/businessCaseController.js` or validation schema
**Test Evidence:** `/backend/tests/businessCase.test.js`

**Issue:**
Tests use different data structure than validation schema expects.

**Validation Schema Expects:**
```javascript
{
  customerId: UUID,
  caseType: 'pilot' | 'full_implementation',  // NOT 'type'
  industry: string,
  companySize: 'startup' | 'small' | 'medium' | 'large' | 'enterprise',
  budget: number,
  timeline: number,  // months as number, NOT string
  objectives: string[],
  successMetrics: string[]
}
```

**Tests Send:**
```javascript
{
  customerId: UUID,
  type: 'pilot',  // Should be 'caseType'
  requirements: {  // Should be flat structure
    timeline: '3-6 months',  // Should be number
    budget: 50000,
    teamSize: 5,
    successMetrics: [...]
  },
  context: {
    industry: 'Technology',  // Should be at root level
    companySize: 'Mid-Market',
    currentChallenges: [...]
  }
}
```

**Failing Tests (7/18):**
- `should generate pilot program business case` - 400 Bad Request
- `should generate full implementation business case` - 400 Bad Request
- Multiple validation tests failing

**Fix Options:**
1. **RECOMMENDED:** Update validation schema to accept both formats for backward compatibility
2. Update controller to transform old format to new format
3. Update all tests to use new format (less preferred - may break frontend)

**Impact:** Business case generation feature broken
**Estimated Fix Time:** 2 hours
**Priority:** HIGH

---

## 🟡 MEDIUM PRIORITY BUGS

### BUG-004: Health Check Returns 503 for Detailed Endpoint
**Severity:** MEDIUM
**File:** `/backend/src/controllers/healthController.js`
**Test Evidence:** `/backend/tests/health.test.js:58`

**Issue:**
`/health/detailed` endpoint returns 503 Service Unavailable in test environment.

**Expected Behavior:**
- Check Supabase connection
- Return health status with dependency info

**Actual Behavior:**
- Returns 503
- Likely still checking for "airtable" dependency instead of "supabase"

**Test Code:**
```javascript
test('should return detailed health status', async () => {
  const response = await request(app)
    .get('/health/detailed')
    .expect(200);  // FAILS - gets 503

  expect(response.body.data.dependencies).toMatchObject({
    supabase: {  // May still be checking 'airtable'
      status: expect.stringMatching(/healthy|unhealthy/),
      responseTime: expect.any(Number)
    }
  });
});
```

**Fix Required:**
1. Update health controller to check Supabase instead of Airtable
2. Handle test environment gracefully (Supabase may not be available)
3. Update dependency name from `airtable` to `supabase`

**Impact:** Monitoring/health checks broken
**Estimated Fix Time:** 30 minutes
**Priority:** MEDIUM

---

### BUG-005: Export Controller Missing Implementations
**Severity:** MEDIUM
**File:** `/backend/src/controllers/exportController.js`
**Test Evidence:** `/backend/tests/export.test.js`

**Issue:**
6 export tests failing due to incomplete controller implementations.

**Failing Tests:**
- Export functionality partially working
- Some endpoints return errors or incomplete data

**Investigation Needed:**
1. Verify PDF generation library is working
2. Check DOCX export functionality
3. Ensure JSON/CSV exports have correct data
4. Validate Supabase data retrieval

**Impact:** Export features partially broken
**Estimated Fix Time:** 1 hour
**Priority:** MEDIUM

---

### BUG-006: Business Case History Returns 403 Forbidden
**Severity:** MEDIUM
**File:** `/backend/src/controllers/businessCaseController.js`
**Test Evidence:** `/backend/tests/businessCase.test.js`

**Issue:**
History endpoint returns 403 Forbidden instead of 200.

**Test Code:**
```javascript
test('should retrieve business case history', async () => {
  mockSupabaseDataService.getCustomerById.mockResolvedValue(mockCustomer);

  const response = await request(app)
    .get(`/api/business-case/${testCustomerId}/history`)
    .set(withAuth(testCustomerId))
    .expect(200);  // FAILS - gets 403
});
```

**Possible Causes:**
1. Route not registered correctly
2. Missing authentication middleware configuration
3. Customer ownership validation too strict

**Impact:** Users can't see their history
**Estimated Fix Time:** 30 minutes
**Priority:** MEDIUM

---

## 🔵 LOW PRIORITY BUGS

### BUG-007: Export Format Validation Not Working
**Severity:** LOW
**File:** `/backend/src/controllers/exportController.js`
**Test Evidence:** `/backend/tests/businessCase.test.js`

**Issue:**
Export endpoint accepts invalid formats when it should reject them.

**Test Code:**
```javascript
test('should validate export format', async () => {
  const response = await request(app)
    .post('/api/business-case/export')
    .send({ customerId, format: 'invalid' })
    .set(withAuth(customerId))
    .expect(400);  // FAILS - gets 200
});
```

**Expected:** Validation middleware should reject invalid formats
**Actual:** Controller accepts and processes invalid formats

**Impact:** May cause runtime errors on export
**Estimated Fix Time:** 20 minutes
**Priority:** LOW

---

## 📊 DATABASE FIELD MAPPING ISSUES

### ISSUE-001: Incomplete Airtable → Supabase Field Migration
**Severity:** MEDIUM
**Multiple Files:** Various controllers

**Known Field Mapping Gaps:**

| Airtable Field (PascalCase) | Supabase Field (snake_case) | Status |
|-----------------------------|----------------------------|--------|
| `Customer ID` | `customer_id` | ✅ Fixed |
| `Cost Calculator Content` | `cost_calculator_content` | ⚠️ Partial |
| `ICP Content` | `icp_content` | ❌ Not migrated |
| `Business Case Content` | `business_case_content` | ⚠️ Partial |
| `Customer Name` | `customer_name` | ✅ Fixed |

**Required Action:**
1. Create complete field mapping table
2. Systematically update all controllers
3. Search codebase for PascalCase field names
4. Replace with snake_case equivalents
5. Update all database queries
6. Update response formatting

**Affected Controllers:**
- costCalculatorController.js
- exportController.js
- businessCaseController.js
- icpFrameworkController.js
- customerController.js
- progressController.js

**Estimated Fix Time:** 2-3 hours
**Priority:** MEDIUM

---

## 📋 TEST INFRASTRUCTURE STATUS

### ✅ Completed (Agent 1)
- All test files now use proven ES module mocking pattern
- All `CUST_XXX` legacy tokens replaced with UUIDs
- All test files use `withAuth()` helper correctly
- All mocks use `supabaseDataService` instead of `airtableService`

### 📊 Test Pass Rates by File
| File | Tests | Pass | Rate | Status |
|------|-------|------|------|--------|
| customer.test.js | 11 | 11 | 100% | ✅ Perfect |
| ai-integration.test.js | 6 | 6 | 100% | ✅ Perfect |
| auth-basic.test.js | 4 | 4 | 100% | ✅ Perfect |
| auth.test.js | 22 | 16 | 72.7% | 🟨 Good |
| export.test.js | 21 | 15 | 71% | 🟨 Good |
| businessCase.test.js | 18 | 11 | 61% | 🟡 Acceptable |
| health.test.js | 5 | 4 | 80% | 🟨 Good |
| validation.test.js | 55 | 24 | 44% | 🟡 Needs work |
| costCalculator.test.js | 15 | 4 | 26.7% | 🔴 Poor |

**Overall:** 95/157 tests passing (60.5%)

---

## 🎯 Recommended Fix Order

### Phase 1: Security & Critical (2-3 hours)
1. **BUG-001**: Customer isolation (1 hour) - **BLOCKING**
2. **BUG-002**: Cost calculator 500 errors (1.5 hours)

### Phase 2: High Priority (2-3 hours)
3. **BUG-003**: Business case schema mismatch (2 hours)
4. **BUG-004**: Health check detailed endpoint (30 min)

### Phase 3: Medium Priority (2 hours)
5. **BUG-005**: Export controller gaps (1 hour)
6. **BUG-006**: Business case history 403 (30 min)
7. **ISSUE-001**: Field mapping audit (start)

### Phase 4: Low Priority (30 min)
8. **BUG-007**: Export format validation (20 min)

**Total Estimated Time:** 6.5-8.5 hours

---

## 🧪 Testing Strategy

After each fix:
1. Run specific test file: `NODE_OPTIONS="--experimental-vm-modules" npm test -- <filename>.test.js`
2. Verify tests pass
3. Run full suite: `NODE_OPTIONS="--experimental-vm-modules" npm test`
4. Check overall pass rate improved
5. Document any new issues discovered

---

## 📝 Notes for Agent 2

### What's Already Working
- Test infrastructure is solid
- ES module mocking pattern established
- UUID format standardized
- Authentication headers correct
- All Supabase mocks configured

### What Needs Your Attention
- Controller implementations have bugs
- Database field mappings incomplete
- Validation schemas may need updating
- Some endpoints missing or misconfigured

### Support Available
- Agent 1 can help debug failing tests
- Test evidence provided for each bug
- Proven patterns documented

### Success Criteria
- Fix BUG-001 (security) BEFORE any other work
- Achieve 80%+ test pass rate
- All HIGH priority bugs fixed
- Field mapping audit complete

---

**Questions?** Contact Agent 1 for test infrastructure support.
**Priority:** Fix BUG-001 immediately - blocks production deployment.
